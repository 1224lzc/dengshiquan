<html style=""><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <style type="text/css">.amap-indoor-map .label-canvas{position:absolute;top:0;left:0}.amap-indoor-map .highlight-image-con *{pointer-events:none}.amap-indoormap-floorbar-control{position:absolute;margin:auto 0;bottom:165px;right:12px;width:35px;text-align:center;line-height:1.3em;overflow:hidden;padding:0 2px}.amap-indoormap-floorbar-control .panel-box{background-color:rgba(255,255,255,.9);border-radius:3px;border:1px solid #ccc}.amap-indoormap-floorbar-control .select-dock{position:absolute;top:0;left:0;width:100%;box-sizing:border-box;height:30px;border:solid #4196ff;border-width:0 2px;border-radius:2px;pointer-events:none;background:linear-gradient(to bottom,#f6f8f9 0,#e5ebee 50%,#d7dee3 51%,#f5f7f9 100%)}.amap-indoor-map .transition{transition:opacity .2s},.amap-indoormap-floorbar-control .transition{transition:top .2s,margin-top .2s}.amap-indoormap-floorbar-control .select-dock:after,.amap-indoormap-floorbar-control .select-dock:before{content:"";position:absolute;width:0;height:0;left:0;top:10px;border:solid transparent;border-width:4px;border-left-color:#4196ff}.amap-indoormap-floorbar-control .select-dock:after{right:0;left:auto;border-left-color:transparent;border-right-color:#4196ff}.amap-indoormap-floorbar-control.is-mobile{width:37px}.amap-indoormap-floorbar-control.is-mobile .floor-btn{height:35px;line-height:35px}.amap-indoormap-floorbar-control.is-mobile .select-dock{height:35px;top:36px}.amap-indoormap-floorbar-control.is-mobile .select-dock:after,.amap-indoormap-floorbar-control.is-mobile .select-dock:before{top:13px}.amap-indoormap-floorbar-control.is-mobile .floor-list-box{height:105px}.amap-indoormap-floorbar-control .floor-list-item .floor-btn{color:#555;font-family:"Times New Roman",sans-serif,"Microsoft Yahei";font-size:16px}.amap-indoormap-floorbar-control .floor-list-item.selected .floor-btn{color:#000}.amap-indoormap-floorbar-control .floor-btn{height:28px;line-height:28px;overflow:hidden;cursor:pointer;position:relative;-webkit-touch-callout:none;-webkit-user-select:none;-khtml-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.amap-indoormap-floorbar-control .floor-btn:hover{background-color:rgba(221,221,221,.4)}.amap-indoormap-floorbar-control .floor-minus,.amap-indoormap-floorbar-control .floor-plus{position:relative;text-indent:-1000em}.amap-indoormap-floorbar-control .floor-minus:after,.amap-indoormap-floorbar-control .floor-plus:after{content:"";position:absolute;margin:auto;top:9px;left:0;right:0;width:0;height:0;border:solid transparent;border-width:10px 8px;border-top-color:#777}.amap-indoormap-floorbar-control .floor-minus.disabled,.amap-indoormap-floorbar-control .floor-plus.disabled{opacity:.3}.amap-indoormap-floorbar-control .floor-plus:after{border-bottom-color:#777;border-top-color:transparent;top:-3px}.amap-indoormap-floorbar-control .floor-list-box{max-height:153px;position:relative;overflow-y:hidden}.amap-indoormap-floorbar-control .floor-list{margin:0;padding:0;list-style:none}.amap-indoormap-floorbar-control .floor-list-item{position:relative}.amap-indoormap-floorbar-control .floor-btn.disabled,.amap-indoormap-floorbar-control .floor-btn.disabled *,.amap-indoormap-floorbar-control.with-indrm-loader *{-webkit-pointer-events:none!important;pointer-events:none!important}.amap-indoormap-floorbar-control .with-indrm-loader .floor-nonas{opacity:.5}.amap-indoor-map-moverf-marker{color:#555;background-color:#FFFEEF;border:1px solid #7E7E7E;padding:3px 6px;font-size:12px;white-space:nowrap;display:inline-block;position:absolute;top:1em;left:1.2em}.amap-indoormap-floorbar-control .amap-indrm-loader{-moz-animation:amap-indrm-loader 1250ms infinite linear;-webkit-animation:amap-indrm-loader 1250ms infinite linear;animation:amap-indrm-loader 1250ms infinite linear;border:2px solid #91A3D8;border-right-color:transparent;box-sizing:border-box;display:inline-block;overflow:hidden;text-indent:-9999px;width:13px;height:13px;border-radius:7px;position:absolute;margin:auto;top:0;left:0;right:0;bottom:0}@-moz-keyframes amap-indrm-loader{0%{-moz-transform:rotate(0deg);transform:rotate(0deg)}100%{-moz-transform:rotate(360deg);transform:rotate(360deg)}}@-webkit-keyframes amap-indrm-loader{0%{-webkit-transform:rotate(0deg);transform:rotate(0deg)}100%{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}@keyframes amap-indrm-loader{0%{-moz-transform:rotate(0deg);-ms-transform:rotate(0deg);-webkit-transform:rotate(0deg);transform:rotate(0deg)}100%{-moz-transform:rotate(360deg);-ms-transform:rotate(360deg);-webkit-transform:rotate(360deg);transform:rotate(360deg)}}</style><style type="text/css">.amap-logo{display:block!important;pointer-events:none;}</style><style type="text/css" class="AMap.style">.vml{behavior:url(#default#VML);display:inline-block;position:absolute}.amap-custom{top:0;left:0;position:absolute}.amap-container img{max-width:none!important;max-height:none!important}.amap-container{touch-action:none;position:relative;overflow:hidden;background:#fcf9f2 url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAfQAAAH0AgMAAAC2uDcZAAAADFBMVEX////////////////1pQ5zAAAABHRSTlMAgP/AWuZC2AAAAVhJREFUeAFiYGAQYGDEQjAB2rcDC4BiGIqiU7abdKlO2QkeIClyPsDHweMKtOPHIJ1Op6/w7Y4fdqfT6VpndzqdrnV2p9PpWmd3Oj3qWndSoKp+2J1Op7vr7E6n07XO7nQ6XevsTqfTtc7udPo4/f787E6n0911dqfT6VpndzqdrnV2p9PpWmd3Ot27Ce8m6HS6u85dR6fTtU7r6HS61mkdnU7XOrvT6XTvJuxOp9PddXan0+laZ3c6na51dDpd67SOTqd7N+HdBJ1Od9e56+h0utZpHZ1O1zq70+l0rbM7nU73bsLudDrdXWd3Ol3rtI5Op2ud1tHpdK3TOjqd7t2EdxN0Ot1dZ3c6na51dqfT6VpndzqdrnV2p9Pp3k3Q6XR3nbuOTqdrndbR6XSt0zo6na51Wken072bsDudTnfX2Z1Op2ud3el0utbZnU7XOq2j0+t0uncTD1gO4zoT5doZAAAAAElFTkSuQmCC);-ms-touch-action:none}.amap-drags,.amap-layers{width:100%;height:100%;position:absolute;overflow:hidden}.amap-layers canvas{-webkit-touch-callout:none;-webkit-user-select:none;-khtml-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.amap-layer img{pointer-events:none}.amap-e,.amap-maps{width:100%;height:100%}.amap-maps,.amap-e,.amap-layers,.amap-tile,.amap-tile-container{position:absolute;left:0;top:0;overflow:hidden}.amap-context{position:absolute;left:0;top:0}.amap-overlays,.amap-markers,.amap-marker{position:absolute;left:0;top:0}.amap-layers{z-index:0}.amap-overlays{z-index:110;cursor:default}.amap-markers{z-index:120}.amap-controls{z-index:150}.amap-copyright{position:absolute;display:block!important;left:85px;height:16px;bottom:.1px;padding-bottom:3px;font-size:11px;font-family:Arial,sans-serif;z-index:160}.amap-logo{position:absolute;bottom:1.5px;left:4px;z-index:160;height:20px}.amap-logo img{width:73px!important;height:20px!important;border:0;vertical-align:baseline!important}.amap-icon{position:relative;z-index:1}.amap-icon img{position:absolute;z-index:-1}.amap-marker-label{position:absolute;z-index:2;border:1px solid blue;background-color:white;white-space:nowrap;cursor:default;padding:3px;font-size:12px;line-height:14px}.amap-info{position:absolute;left:0;z-index:140;width:320px}.amap-menu{position:absolute;z-index:140;_width:100px}.amap-info-close{position:absolute;right:5px;_right:12px;+right:11px;top:5px;_top:2px;+top:2px;color:#c3c3c3;text-decoration:none;font:bold 16px/14px Tahoma,Verdana,sans-serif;width:14px;height:14px}.amap-info-outer,.amap-menu-outer{box-shadow:0 1px 2px rgba(0,0,0,0.1);background:none repeat scroll 0 0 white;border-radius:2px;padding:1px;text-align:left}.amap-menu-outer:hover{box-shadow:0 1px 2px rgba(0,0,0,0.3)}.amap-info-contentContainer:hover .amap-info-outer{box-shadow:0 1px 2px rgba(0,0,0,0.3)}.amap-info-content{position:relative;background:#fff;padding:10px 18px 10px 10px;line-height:1.4;overflow:auto}.amap-marker-content{position:relative}.amap-info{_width:320px}.amap-menu{_width:100px}.amap-info-sharp-old{overflow:hidden;position:absolute;background-image:url(http://webapi.amap.com/images/arrows.png)}.bottom-center .amap-info-sharp-old{height:12px;margin:0 auto;width:20px;background-position:center 12px;top:100%;margin-top:-9px;left:50%;margin-left:-10px}.bottom-left .amap-info-sharp-old{height:12px;width:13px;background-position:-16px -46px;top:100%;margin-top:-9px}.bottom-right .amap-info-sharp-old{height:12px;width:13px;top:-1px;background-position:-56px -46px;left:100%;margin-left:-13px;top:100%;margin-top:-9px}.middle-left .amap-info-sharp-old{height:20px;width:12px;background-position:left;top:50%;margin-top:-10px;margin-left:-11px}.center .amap-info-sharp-old{display:none}.middle-right .amap-info-sharp-old{height:20px;margin-right:0;width:12px;background-position:right;left:100%;margin-left:-9px;top:50%;margin-top:-10px}.top-center .amap-info-sharp-old{height:12px;margin:0 auto;width:20px;background-position:top;top:0;margin-top:-3px;left:50%;margin-left:-10px}.top-left .amap-info-sharp-old{height:12px;width:13px;background-position:-16px -3px;top:0;margin-top:-3px}.top-right .amap-info-sharp-old{height:12px;width:13px;background-position:-56px -3px;left:100%;margin-left:-13px;top:0;margin-top:-3px}.amap-info-sharp{position:absolute}.bottom-center .amap-info-sharp{bottom:0;left:50%;margin-left:-8px;border-left:8px solid transparent;border-right:8px solid transparent;border-top:8px solid #fff}.bottom-center .amap-info-sharp:after{position:absolute;content:"";margin-left:-8px;margin-top:-7px;border-left:8px solid transparent;border-right:8px solid transparent;border-top:8px solid rgba(0,0,0,0.3);filter:blur(2px);z-index:-1}.amap-info-contentContainer:hover.bottom-center .amap-info-sharp:after{border-top:8px solid rgba(0,0,0,0.5)}.bottom-left .amap-info-sharp{border-color:transparent #fff;border-width:0 0 10px 10px;border-style:solid}.bottom-left .amap-info-sharp:after{position:absolute;content:"";margin-left:-10px;border-color:transparent rgba(0,0,0,0.3);border-width:0 0 10px 10px;border-style:solid;filter:blur(1px);z-index:-1}.amap-info-contentContainer:hover.bottom-left .amap-info-sharp:after{border-color:transparent rgba(0,0,0,0.5)}.bottom-left .amap-info-content{border-radius:2px 2px 2px 0}.bottom-right .amap-info-sharp{right:0;border-top:10px solid #fff;border-left:10px solid transparent}.bottom-right .amap-info-sharp:after{position:absolute;margin-top:-9px;margin-left:-10px;content:"";border-top:10px solid rgba(0,0,0,0.3);border-left:10px solid transparent;filter:blur(1px);z-index:-1}.amap-info-contentContainer:hover.bottom-right .amap-info-sharp:after{border-top:10px solid rgba(0,0,0,0.5)}.bottom-right .amap-info-content{border-radius:2px 2px 0 2px}.top-center .amap-info-sharp{top:0;left:50%;margin-left:-8px;border-left:8px solid transparent;border-right:8px solid transparent;border-bottom:8px solid #fff}.top-center .amap-info-sharp:after{position:absolute;content:"";margin-top:0;margin-left:-8px;border-left:8px solid transparent;border-right:8px solid transparent;border-bottom:8px solid rgba(0,0,0,0.3);filter:blur(1px);z-index:-1}.top-left .amap-info-sharp{left:0;top:0;border-bottom:10px solid #fff;border-right:10px solid transparent}.top-left .amap-info-sharp:after{position:absolute;content:"";margin-top:0;margin-left:0;border-bottom:10px solid rgba(0,0,0,0.3);border-right:10px solid transparent;filter:blur(1px);z-index:-1}.top-right .amap-info-sharp{right:0;top:0;border-bottom:10px solid #fff;border-left:10px solid transparent}.top-right .amap-info-sharp:after{position:absolute;content:"";margin-top:0;margin-left:-10px;border-bottom:10px solid rgba(0,0,0,0.3);border-left:10px solid transparent;filter:blur(1px);z-index:-1}.middle-right .amap-info-sharp{right:0;top:50%;margin-top:-8px;border-top:8px solid transparent;border-left:8px solid #fff;border-bottom:8px solid transparent}.middle-right .amap-info-sharp:after{position:absolute;content:"";margin-top:-8px;margin-left:-8px;border-top:8px solid transparent;border-left:8px solid rgba(0,0,0,0.3);border-bottom:8px solid transparent;filter:blur(1px);z-index:-1}.amap-info-contentContainer:hover.middle-right .amap-info-sharp:after{border-left:8px solid rgba(0,0,0,0.5)}.middle-left .amap-info-sharp{left:0;top:50%;margin-top:-8px;border-top:8px solid transparent;border-right:8px solid #fff;border-bottom:8px solid transparent}.middle-left .amap-info-sharp:after{position:absolute;content:"";margin-top:-8px;margin-left:0;border-top:8px solid transparent;border-right:8px solid rgba(0,0,0,0.3);border-bottom:8px solid transparent;filter:blur(1px);z-index:-1}.amap-info-contentContainer:hover.middle-left .amap-info-sharp:after{border-right:8px solid rgba(0,0,0,0.5)}.amap-info-contentContainer.top-left,.amap-info-contentContainer.top-center,.amap-info-contentContainer.top-right{padding-top:8px}.amap-info-contentContainer.bottom-left,.amap-info-contentContainer.bottom-center,.amap-info-contentContainer.bottom-right{padding-bottom:8px}.amap-info-contentContainer.middle-right{padding-right:8px}.amap-info-contentContainer.middle-left{padding-left:8px}.amap-menu-outer{margin:0;padding:0;list-style-type:none}ul.amap-menu-outer li{cursor:pointer;height:35px;line-height:35px;word-break:break-all;padding:0 10px;font-size:12px;white-space:nowrap}ul.amap-menu-outer li a{text-decoration:none;font-size:13px;margin:0 5px;color:#000;padding:5px 5px}ul.amap-menu-outer li:hover{background-color:#f3f3ee}.amap-overlay-text-container{display:block;width:auto;word-break:keep-all;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;background:#fff;padding:2px 3px;border:1px solid #ccc;border-radius:3px}.amap-overlay-text-container.amap-overlay-text-empty{display:none}.amap-info-content-ie8{border:1px solid #9c9c9c}</style><meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <title>等时圈-By刘子晨</title>
    <link rel="stylesheet" href="demo-center.css">
    <style type="text/css">
        html,
        body,
        #container {
            height: 100%;
        }
        
        .btn {
            margin-left: 0.5rem;
            width: 4rem;
        }
    </style>
    <link rel="stylesheet" href="jquery.range.css">
<style type="text/css">.amap-container{cursor:url(https://webapi.amap.com/theme/v1.3/openhand.cur),default;}.amap-drag{cursor:url(https://webapi.amap.com/theme/v1.3/closedhand.cur),default;}</style></head>

<body>
    <div id="container" style="position: relative; background: rgb(242, 242, 242);" class="amap-container"><object style="display: block; position: absolute; top: 0; left: 0; height: 100%; width: 100%; overflow: hidden; pointer-events: none; z-index: -1;" type="text/html" data="%E7%AD%89%E6%97%B6%E5%9C%88-By%E5%88%98%E5%AD%90%E6%99%A8_files/%E6%97%A0%E6%A0%87%E9%A2%98.htm"></object><div class="amap-maps"><div class="amap-drags" style=""><div class="amap-layers" style="transform: translateZ(0px);"><div class="amap-markers" style="position: absolute; z-index: 120; top: 236px; left: 960px;"><div class="amap-marker" style="top: -89px; left: -61px; z-index: 100; transform: rotate(0deg); transform-origin: 9px 31px 0px; display: block;"><div class="amap-icon" style="position: absolute; overflow: hidden; width: 19px; height: 33px; opacity: 1;"><img style="width: 19px; height: 33px; top: 0px; left: 0px;" src="%E7%AD%89%E6%97%B6%E5%9C%88-By%E5%88%98%E5%AD%90%E6%99%A8_files/mark_bs.png"></div></div></div><canvas class="amap-layer" width="1920" height="472" style="position: absolute; z-index: 0; top: 0px; left: 0px; display: block; height: 472px; width: 1920px;"></canvas><canvas class="amap-layer amap-vectors" style="position: absolute; z-index: 110; top: 0px; left: 0px; display: block;" width="1920" height="472"></canvas><canvas class="amap-labels" draggable="false" width="1920" height="472" style="position: absolute; z-index: 99; height: 472px; width: 1920px; top: 0px; left: 0px;"></canvas></div><div class="amap-overlays" style=""></div></div></div><div style="display: none;"></div><div class="amap-controls"></div><a class="amap-logo"><img src="%E7%AD%89%E6%97%B6%E5%9C%88-By%E5%88%98%E5%AD%90%E6%99%A8_files/logo@1x.png"></a><div class="amap-copyright" style="display: none; visibility: hidden;"><!--v1.4.16--> © 2024 AutoNavi <span class="amap-mcode"></span></div></div>
    <div class="input-card" style="width:30rem;">
        <h4 style="color:black">Mapbox等时圈、高德公交到达圈查询-By刘子晨</h4>
        <div class="input-item">
            <div class="input-item-prepend"><span class="input-item-text">出发位置</span></div>
            <input id="lnglat" type="text" value="118.351383,32.301764">
        </div>
        <div class="input-item" style="margin-bottom:2rem;">
            <label>时长(分钟)</label>
            <input type="hidden" id="t" class="single-slider" value="60" style="display: none;"><div class="slider-container theme-green" style="width: 400px;">			<div class="back-bar">                <div class="selected-bar" style="width: 330px; left: 0px;"></div>                <div class="pointer low" style="display: none;"></div><div class="pointer-label" style="display: none;">123456</div>                <div class="pointer high" style="left: 324px;"></div><div class="pointer-label" style="left: 326px;">60</div>                <div class="clickable-dummy"></div>            </div>            <div class="scale"><span style="left: 0%"><ins style="margin-left: -2.5px;">1</ins></span><span style="left: 25%"><ins style="margin-left: -5px;">15</ins></span><span style="left: 50%"><ins style="margin-left: -5px;">30</ins></span><span style="left: 75%"><ins style="margin-left: -5px;">45</ins></span><span style="left: 100%"><ins style="margin-left: -5px;">60</ins></span></div>		</div>
        </div>
        <div class="input-item">
            <div class="input-item-prepend">
                <label class="input-item-text">出行方式</label>
            </div>
            <select iname="v" id="v">
                <option value="SUBWAY,BUS">地铁+公交(高德)</option>
                <option value="SUBWAY">地铁(高德)</option>
                <option value="BUS">公交(高德)</option>
                <option value="walking" selected="selected">步行(Mapbox)</option>
                <option value="cycling">骑行(Mapbox)</option>
                <option value="driving">驾车(Mapbox)</option>
            </select>
            <input id="search" type="button" class="btn" value="查询">
            <input id="clear" type="button" class="btn" value="清除">
        </div>
        <div class="input-item">
            <label class="input-item-text" style="width:6rem;">导出坐标系</label>
            <select name="coord" id="coord">
                <option value="WGS84" selected="selected">WGS84</option>
                <option value="GCJ02">GCJ02</option>
            </select>
            <input type="button" class="btn" value="导出geojson" onclick="javascript:outputjson()" style="width:8rem;">
            <input type="button" class="btn" value="MapShaper" onclick="javascript:outputshp()" style="width:6rem;">
        </div>
    </div>
    <script src="maps"></script>
    <script src="jquery-1.9.1.js"></script>
    <script src="jquery.range.js"></script>
    <script src="FileSaver.js"></script>
    <script>
        var accessToken = 'pk.eyJ1IjoibmkxbzEiLCJhIjoiY2t3ZDgzMmR5NDF4czJ1cm84Z3NqOGt3OSJ9.yOYP6pxDzXzhbHfyk3uORg';

        var map = new AMap.Map("container", {
            resizeEnable: true,
            zoomEnable: true,
            center: [116.397428, 39.90923],
            zoom: 10,
            mapStyle: 'amap://styles/c96d75ff867ce8d95400aa40227ed278',
        });

        function getLnglat(e) {
            var lnglat = e.lnglat;
            document.getElementById('lnglat')
                .value = e.lnglat.toString()
            getArriveRange();
        }
        map.on('click', getLnglat);

        var centerMarker;

        function addCenterMarker(position) {
            if (!centerMarker) {
                centerMarker = new AMap.Marker({
                    map: map,
                    position: position
                });
            } else {
                centerMarker.setPosition(position)
            }
        }

        var arrivalRange, polygons = [];
        //添加多边形覆盖物
        function getArriveRange() {
            if (!arrivalRange) {
                arrivalRange = new AMap.ArrivalRange()
            }
            var lnglat = $("#lnglat")
                .val()
                .split(',');
            var t = $("#t")
                .val();
            var v = $("#v")
                .val();

            addCenterMarker(lnglat);
            if ((v == 'SUBWAY,BUS') | (v == 'SUBWAY') | (v == 'BUS')) {
                arrivalRange.search(lnglat, t, function(status, result) {
                    map.remove(polygons);
                    polygons = [];
                    if (result.bounds) {
                        for (var i = 0; i < result.bounds.length; i++) {
                            var polygon = new AMap.Polygon({
                                fillColor: "#336699",
                                fillOpacity: "0.4",
                                strokeColor: "#336699",
                                strokeOpacity: "1",
                                strokeWeight: 2
                            });
                            polygon.setPath(result.bounds[i]);
                            polygons.push(polygon);
                        }
                        map.add(polygons);
                        map.setFitView();
                        map.bounds = result.bounds;
                    }
                }, {
                    policy: v
                });
            } else {
                //Mapbox的查询条件
                var urlBase = 'https://api.mapbox.com/isochrone/v1/mapbox/';
                x = lnglat[0];
                y = lnglat[1];
                lnglat_wgs84 = gcj02towgs84(parseFloat(x), parseFloat(y));
                var query =
                    urlBase +
                    v +
                    '/' +
                    lnglat_wgs84[0].toString() +
                    ',' +
                    lnglat_wgs84[1].toString() +
                    '?contours_minutes=' +
                    t +
                    '&polygons=true&access_token=' +
                    accessToken;
                $.ajax({
                        method: 'GET',
                        url: query
                    })
                    .done(function(data) {
                        map.remove(polygons);
                        polygons = [];
                        if (data['features']) {
                            for (var i = 0; i < data['features'].length; i++) {
                                var polygon = new AMap.Polygon({
                                    fillColor: "#336699",
                                    fillOpacity: "0.4",
                                    strokeColor: "#336699",
                                    strokeOpacity: "1",
                                    strokeWeight: 2
                                });
                                polygonpath = []

                                for (var j = 0; j < data['features'][i]['geometry']['coordinates'][0].length; j++) {
                                    polygonpath.push(wgs84togcj02(data['features'][i]['geometry']['coordinates'][0][j][0], data['features'][i]['geometry']['coordinates'][0][j][1]))
                                }
                                polygon.setPath(polygonpath);
                                polygons.push(polygon);
                            }
                            map.add(polygons);
                            map.setFitView();
                        }

                    });
            }
        }


        var isChanged = false;
        $(function() {
            $('.single-slider')
                .jRange({
                    onstatechange: getArriveRange,
                    from: 1,
                    to: 60,
                    step: 1,
                    scale: [1, 15, 30, 45, 60],
                    format: '%s',
                    width: 400,
                    showLabels: true,
                    showScale: true
                });
        });
        getArriveRange();

        $('#search')
            .on('click', getArriveRange);
        $('#v')
            .on('change', getArriveRange);
        $('#clear')
            .on('click', function() {
                map.remove(polygons)
            });


        //导出模块
        function wgs84togcj02(lng, lat) {
            pi = 3.1415926535897932384626
            ee = 0.00669342162296594323
            a = 6378245.0
            x_pi = 3.14159265358979324 * 3000.0 / 180.0
            dlat = transformlat(lng - 105.0, lat - 35.0)
            dlng = transformlng(lng - 105.0, lat - 35.0)
            radlat = lat / 180.0 * pi
            magic = Math.sin(radlat)
            magic = 1 - ee * magic * magic
            sqrtmagic = Math.sqrt(magic)
            dlat = (dlat * 180.0) / ((a * (1 - ee)) / (magic * sqrtmagic) * pi)
            dlng = (dlng * 180.0) / (a / sqrtmagic * Math.cos(radlat) * pi)
            mglat = lat + dlat
            mglng = lng + dlng
            return [mglng, mglat]
        }

        function gcj02towgs84(lng, lat) {
            pi = 3.1415926535897932384626
            ee = 0.00669342162296594323
            a = 6378245.0
            x_pi = 3.14159265358979324 * 3000.0 / 180.0
            dlat = transformlat(lng - 105.0, lat - 35.0)
            dlng = transformlng(lng - 105.0, lat - 35.0)
            radlat = lat / 180.0 * pi
            magic = Math.sin(radlat)
            magic = 1 - ee * magic * magic
            sqrtmagic = Math.sqrt(magic)
            dlat = (dlat * 180.0) / ((a * (1 - ee)) / (magic * sqrtmagic) * pi)
            dlng = (dlng * 180.0) / (a / sqrtmagic * Math.cos(radlat) * pi)
            mglat = lat + dlat
            mglng = lng + dlng
            return [lng * 2 - mglng, lat * 2 - mglat]
        }

        function transformlat(lng, lat) {
            ret = -100.0 + 2.0 * lng + 3.0 * lat + 0.2 * lat * lat + 0.1 * lng * lat + 0.2 * Math.sqrt(Math.abs(lng))
            ret += (20.0 * Math.sin(6.0 * lng * pi) + 20.0 *
                Math.sin(2.0 * lng * pi)) * 2.0 / 3.0
            ret += (20.0 * Math.sin(lat * pi) + 40.0 *
                Math.sin(lat / 3.0 * pi)) * 2.0 / 3.0
            ret += (160.0 * Math.sin(lat / 12.0 * pi) + 320 *
                Math.sin(lat * pi / 30.0)) * 2.0 / 3.0
            return ret
        }

        function transformlng(lng, lat) {
            ret = 300.0 + lng + 2.0 * lat + 0.1 * lng * lng + 0.1 * lng * lat + 0.1 * Math.sqrt(Math.abs(lng))
            ret += (20.0 * Math.sin(6.0 * lng * pi) + 20.0 *
                Math.sin(2.0 * lng * pi)) * 2.0 / 3.0
            ret += (20.0 * Math.sin(lng * pi) + 40.0 *
                Math.sin(lng / 3.0 * pi)) * 2.0 / 3.0
            ret += (150.0 * Math.sin(lng / 12.0 * pi) + 300.0 *
                Math.sin(lng / 30.0 * pi)) * 2.0 / 3.0
            return ret
        }


        function getgeojson() {

            var lnglat = $("#lnglat")
                .val()
                .split(',');
            x = lnglat[0];
            y = lnglat[1];
            t = $("#t")
                .val();
            v = $("#v")
                .val();
            coord = $("#coord")
                .val();
            if ((v == 'SUBWAY,BUS') | (v == 'SUBWAY') | (v == 'BUS')) {
                geojson = {},
                    polygonArray = []
                for (var i = 0; i < map.bounds.length; i++) {
                    polygonArray1 = []
                    for (var j = 0; j < map.bounds[i][0].length; j++) {
                        if (coord == 'GCJ02') {
                            polygonArray1.push([map.bounds[i][0][j].lng, map.bounds[i][0][j].lat])
                        }
                        if (coord == 'WGS84') {
                            polygonArray1.push(gcj02towgs84(map.bounds[i][0][j].lng, map.bounds[i][0][j].lat))
                        }
                    }
                    polygonArray.push([polygonArray1])
                }

                geojson.type = 'FeatureCollection'
                geometry = {
                    type: 'MultiPolygon',
                    coordinates: polygonArray
                }

                var shape = {}
                shape.type = 'Feature'
                shape.geometry = geometry
                shape.properties = {
                    x: x,
                    y: y,
                    t: t,
                    v: v
                }
                var features = [shape]
                geojson.features = features
                return geojson
            } else { //Mapbox的查询条件
                var urlBase = 'https://api.mapbox.com/isochrone/v1/mapbox/';
                x = lnglat[0];
                y = lnglat[1];
                lnglat_wgs84 = gcj02towgs84(parseFloat(x), parseFloat(y));
                var query =
                    urlBase +
                    v +
                    '/' +
                    lnglat_wgs84[0].toString() +
                    ',' +
                    lnglat_wgs84[1].toString() +
                    '?contours_minutes=' +
                    t +
                    '&polygons=true&access_token=' +
                    accessToken;
                var geojson = []
                $.ajax({
                    method: 'GET',
                    url: query,
                    async: false,
                    success: function(data) {
                        if (coord == 'WGS84') {
                            geojson = data
                        }
                    }
                })
                return geojson
            }
        }

        function outputjson() {
            var geojson = getgeojson();
            var content = JSON.stringify(geojson);

            var blob = new Blob([content], {
                type: "text/plain;charset=utf-8"
            });
            saveAs(blob, "save.json")
        }

        function outputshp() {
            /*
    var api = mapshaper;
    var MapShaper = api.internal;
    var geojson = getgeojson();
    opts = {}
    var dataset = MapShaper.importGeoJSON(geojson,opts)
    opts.format = 'shapefile'
    var files = MapShaper.exportFileContent(dataset,opts)
    api.exportFiles(dataset,opts)
    */
            window.open("http://blog.giscafer.com/mapshaper-plus/", )
                /*
    for(var i=0;i<files.length;i++){
    var content = JSON.stringify(files[i].content);
      var blob = new Blob([content], {type: "text/plain;charset=utf-8"});
  saveAs(blob,"save"+files[i].filename)}
  */

        };
    </script>


</body></html>
